# Multi-Language Subtitle Acquisition Guide

**Story:** 4.X.5 - Task 3  
**Purpose:** Guide for running batch subtitle acquisition for multi-language targets  
**Generated:** 2025-11-18

---

## Prerequisites

### 1. OpenSubtitles API Credentials

You need valid OpenSubtitles.org API credentials. Set environment variables:

```bash
export OPEN_SUBTITLES_API_KEY='your_api_key_here'
export OPEN_SUBTITLES_USERNAME='your_username_here'
export OPEN_SUBTITLES_PASSWORD='your_password_here'
```

**Security Note:** Never commit these credentials to git. They should only be in your local `.env` file.

### 2. Priority List

The batch acquisition script reads from:
```
data/metadata/multi_language_priority_list.md
```

This file was generated by Task 1 and contains 49 prioritized targets across FR, ES, NL, AR languages.

---

## Running Batch Acquisition

### Full Batch Mode (All 49 Targets)

```bash
# Run full batch acquisition
python scripts/fetch_priority_subtitles.py \
    --batch data/metadata/multi_language_priority_list.md

# Expected time: ~5-10 minutes (49 targets × ~10 seconds each)
# Expected output: 30-45 successful acquisitions (target 90%+ success rate)
```

### Resume Mode (Continue After Interruption)

If the acquisition is interrupted, resume from where it left off:

```bash
python scripts/fetch_priority_subtitles.py \
    --batch data/metadata/multi_language_priority_list.md \
    --resume
```

The script tracks progress in `data/metadata/multi_language_acquisition_progress.json`

### Test Mode (Limited Targets)

Test with a small subset first:

```bash
# Test with first 5 targets only
head -50 data/metadata/multi_language_priority_list.md > data/metadata/test_targets.md
python scripts/fetch_priority_subtitles.py \
    --batch data/metadata/test_targets.md
```

---

## Expected Output

### Files Created

All acquired subtitle files are saved to:
```
data/raw/subtitles_improved/{film_slug}_{language}_v2.srt
```

Example files:
- `spirited_away_fr_v2.srt`
- `howls_moving_castle_nl_v2.srt`
- `princess_mononoke_ar_v2.srt`

### Acquisition Log

Metadata saved to:
```
data/metadata/acquisition_log_4_X_5.json
```

Contains:
- Timestamp
- Targets attempted
- Success/failure counts
- Success rate
- Detailed results per film

### Progress Tracking

Progress log saved to:
```
data/metadata/multi_language_acquisition_progress.json
```

Format:
```json
{
  "spirited_away": ["fr", "es"],
  "howls_moving_castle": ["nl"],
  ...
}
```

---

## Monitoring Progress

### Console Output

The script provides real-time progress:

```
============================================================
OpenSubtitles Priority Film Subtitle Fetcher
Story 4.X.2 + 4.X.5: Multi-Language Acquisition
============================================================
Mode: BATCH (from data/metadata/multi_language_priority_list.md)
Batch targets: 49
...

[1/49] Film: Howl's Moving Castle (2004)
Language: NL | Priority Score: 95
  → Searching for Howl's Moving Castle (2004) - lang: nl...
  ✓ Found 25 results
  → Filtering 25 results for quality...
  ✓ Selected subtitle:
    - Uploader: SubtitleGuru
    - Downloads: 12,345
    - Hearing Impaired: No
  → Downloading file_id 123456...
  ✓ Downloaded 45,678 bytes
  ✓ Saved to: data/raw/subtitles_improved/howls_moving_castle_nl_v2.srt

[2/49] Film: Kiki's Delivery Service (1989)
...
```

### Error Handling

If a subtitle fails:
```
[15/49] Film: Some Film (2001)
Language: FR | Priority Score: 70
  → Searching for Some Film (2001) - lang: fr...
  ✓ Found 3 results
  → Filtering 3 results for quality...
  ✗ No suitable candidates after filtering
  ✗ Failed to fetch FR subtitles
```

The script continues to the next target. Failed acquisitions are logged in the final summary.

---

## Quality Filters

The script automatically applies quality filters (from Story 4.X.2):

1. **Language Match**: Exact language code match
2. **Download Count**: Higher download count = higher quality
3. **Non-Hearing Impaired**: Strongly preferred (adds +10,000 to score)
4. **Runtime Matching**: Prioritizes subtitles matching documented film runtime

---

## Post-Acquisition Steps

After acquisition completes:

### 1. Verify Files

Check that files were created:
```bash
ls -lh data/raw/subtitles_improved/*_v2.srt | wc -l
# Expected: 30-45 files
```

### 2. Spot-Check Quality

Manually review a few files:
```bash
# Check first 20 lines of a French subtitle
head -20 data/raw/subtitles_improved/spirited_away_fr_v2.srt

# Check file sizes (should be >10 KB for full films)
ls -lh data/raw/subtitles_improved/*_v2.srt | head -10
```

### 3. Run Validation (Task 4)

Validate timing accuracy:
```bash
python src/validation/validate_subtitle_timing.py \
    --directory data/raw/subtitles_improved/ \
    --output data/processed/subtitle_validation_multi_language_v2.json
```

### 4. Check Success Rate

Review acquisition log:
```bash
cat data/metadata/acquisition_log_4_X_5.json | grep -E "(success_rate|subtitles_acquired)"
```

Target: 90%+ success rate (40+/49 files)

---

## Troubleshooting

### Rate Limiting (429 Error)

If you hit rate limits:
```
⚠️  Rate limited. Waiting 5s...
```

The script automatically waits and retries. OpenSubtitles API limits:
- 200 downloads/day
- 40 requests/10 seconds

### Authentication Failure

If login fails:
```
✗ Failed to authenticate.
```

Check:
1. API key is valid
2. Username/password are correct
3. Account is not suspended

### No Results Found

If many searches return no results:
```
✓ Found 0 results
```

Possible causes:
1. Film title mismatch (try alternative titles)
2. Year mismatch
3. Language not available

**Solution:** Manual refinement required (see Story 4.X.2 refinement process)

---

## Refinement Process (For Failed Acquisitions)

If some acquisitions fail, use the refinement script:

```bash
# Identify failed targets from acquisition log
cat data/metadata/acquisition_log_4_X_5.json | jq '.results[] | select(.file_id == null)'

# Create refinement list with failed targets
# Then re-run with adjusted search parameters
```

Refer to Story 4.X.2 completion notes for refinement methodology.

---

## Expected Outcomes

### Success Metrics (AC2)

- **Minimum:** 25/30 files achieve PASS status (83% success rate)
- **Stretch:** 45/50 files achieve PASS status (90% success rate)
- **All files:** <2% timing drift

### Pass Rate Improvement

- **Before:** 52.2% (70/134 files)
- **After (conservative):** 75% (100/134 files)
- **After (stretch):** 89% (120/134 files)

### Featured Films

All 5 featured films should have PASS status across all 4 non-English languages:
- Spirited Away: FR, ES, NL, AR
- Princess Mononoke: FR, ES, NL, AR
- My Neighbor Totoro: FR, ES, NL, AR
- Howl's Moving Castle: FR, ES, NL, AR
- Kiki's Delivery Service: FR, ES, NL, AR

---

## Next Steps After Acquisition

1. **Task 4:** Run validation on acquired files
2. **Task 5:** Re-run emotion analysis on improved subtitles
3. **Task 6:** Update metrics and documentation
4. **Task 7:** Run full validation and testing

---

**Generated by:** Story 4.X.5 - Task 3  
**Date:** 2025-11-18  
**Script:** `scripts/fetch_priority_subtitles.py`



